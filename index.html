<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>All-in-One Video Downloader</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style id="app-style">
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3f37c9;
      --accent-color: #4cc9f0;
      --background-color: #f8f9fa;
      --text-color: #212529;
      --light-gray: #e9ecef;
      --dark-gray: #6c757d;
    }
    
    body {
      background-color: var(--background-color);
      color: var(--text-color);
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
      padding-top: 2rem;
    }
    
    .hero-section {
      text-align: center;
      padding: 2rem 1rem;
    }
    
    .hero-title {
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 1.5rem;
    }
    
    .hero-subtitle {
      color: var(--dark-gray);
      font-size: 1.2rem;
      margin-bottom: 2rem;
    }
    
    .url-input-container {
      position: relative;
      max-width: 800px;
      margin: 0 auto;
    }
    
    .url-input {
      padding-right: 7rem;
      height: 60px;
      font-size: 1.1rem;
      border-radius: 30px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      border: 2px solid transparent;
      transition: all 0.3s;
    }
    
    .url-input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 5px 20px rgba(67, 97, 238, 0.3);
    }
    
    .paste-btn {
      position: absolute;
      right: 120px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--dark-gray);
      cursor: pointer;
    }
    
    .detect-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 25px;
      padding: 0.5rem 1.5rem;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .detect-btn:hover {
      background-color: var(--secondary-color);
    }
    
    .platform-icons {
      display: flex;
      justify-content: center;
      margin: 2rem 0;
      gap: 1.5rem;
    }
    
    .platform-icon {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      opacity: 0.7;
      transition: all 0.3s;
    }
    
    .platform-icon:hover {
      opacity: 1;
    }
    
    .platform-icon.active {
      opacity: 1;
      transform: scale(1.1);
    }
    
    .platform-icon i {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      background: #f8f9fa;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .instagram i {
      color: #e1306c;
    }
    
    .facebook i {
      color: #1877f2;
    }
    
    .tiktok i {
      color: #000000;
    }
    
    .youtube i {
      color: #ff0000;
    }
    
    .video-preview {
      margin: 2rem auto;
      max-width: 800px;
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      display: none;
    }
    
    .video-thumbnail {
      position: relative;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 1rem;
    }
    
    .video-thumbnail img {
      width: 100%;
      height: auto;
      object-fit: cover;
    }
    
    .video-duration {
      position: absolute;
      right: 10px;
      bottom: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 0.2rem 0.5rem;
      border-radius: 5px;
      font-size: 0.85rem;
    }
    
    .video-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    
    .format-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin: 1.5rem 0;
    }
    
    .format-toggle, .quality-dropdown {
      flex: 1;
      min-width: 200px;
    }
    
    .format-btn {
      width: 100%;
      padding: 0.75rem;
      border: none;
      border-radius: 30px;
      background: var(--light-gray);
      color: var(--dark-gray);
      font-weight: 500;
      transition: all 0.3s;
    }
    
    .format-btn.active {
      background: var(--primary-color);
      color: white;
    }
    
    .download-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 30px;
      padding: 1rem 2rem;
      font-size: 1.1rem;
      font-weight: 600;
      transition: all 0.3s;
      width: 100%;
      margin-top: 1.5rem;
    }
    
    .download-btn:hover {
      background: var(--secondary-color);
      transform: translateY(-2px);
    }
    
    .download-btn:active {
      transform: translateY(0);
    }
    
    .download-link {
      display: block;
      text-align: center;
      text-decoration: none;
      background: var(--primary-color);
      color: white;
      border-radius: 30px;
      padding: 1rem 2rem;
      font-size: 1.1rem;
      font-weight: 600;
      transition: all 0.3s;
      margin-top: 1.5rem;
      display: none;
    }
    
    .download-link:hover {
      background: var(--secondary-color);
      color: white;
      transform: translateY(-2px);
    }
    
    .ad-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 2rem auto;
      background: #eeeeee;
      border-radius: 10px;
    }
    
    .ad-container.banner {
      width: 728px;
      height: 90px;
      max-width: 100%;
    }
    
    .ad-container.rectangle {
      width: 300px;
      height: 250px;
    }
    
    .ad-text {
      color: #999;
      font-size: 0.9rem;
    }
    
    .loader {
      display: none;
      text-align: center;
      margin: 2rem 0;
    }
    
    .spinner-border {
      width: 3rem;
      height: 3rem;
      color: var(--primary-color);
    }
    
    .error-message {
      display: none;
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
      padding: 1rem;
      border-radius: 10px;
      margin: 1rem 0;
      text-align: center;
    }
    
    footer {
      padding: 2rem 0;
      text-align: center;
      color: var(--dark-gray);
      margin-top: 2rem;
      background: white;
      box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.05);
    }
    
    .disclaimer {
      font-size: 0.85rem;
      max-width: 800px;
      margin: 0 auto 1rem;
      padding: 0 1rem;
    }
    
    @media (max-width: 768px) {
      .url-input {
        height: 50px;
        padding-right: 110px;
      }
      
      .paste-btn {
        right: 90px;
      }
      
      .platform-icons {
        gap: 0.8rem;
      }
      
      .platform-icon i {
        font-size: 1.5rem;
        width: 50px;
        height: 50px;
      }
      
      .video-title {
        font-size: 1.2rem;
      }
      
      .ad-container.banner {
        height: 60px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Top Banner Ad -->
    <div class="ad-container banner mx-auto" data-ad-slot="top-banner">
      <span class="ad-text">Ad Space (728x90)</span>
    </div>
    
    <section class="hero-section">
      <h1 class="hero-title">All-in-One Video Downloader</h1>
      <p class="hero-subtitle">Download videos from Instagram, Facebook, TikTok, and YouTube</p>
      
      <div class="url-input-container">
        <input type="text" class="form-control url-input" id="videoUrl" placeholder="Paste video link here...">
        <button class="paste-btn" id="pasteBtn" title="Paste from clipboard">
          <i class="fas fa-paste fa-lg"></i>
        </button>
        <button class="detect-btn" id="detectBtn">Detect</button>
      </div>
      
      <div class="platform-icons">
        <div class="platform-icon instagram" data-platform="instagram">
          <i class="fab fa-instagram"></i>
          <span>Instagram</span>
        </div>
        <div class="platform-icon facebook" data-platform="facebook">
          <i class="fab fa-facebook"></i>
          <span>Facebook</span>
        </div>
        <div class="platform-icon tiktok" data-platform="tiktok">
          <i class="fab fa-tiktok"></i>
          <span>TikTok</span>
        </div>
        <div class="platform-icon youtube" data-platform="youtube">
          <i class="fab fa-youtube"></i>
          <span>YouTube</span>
        </div>
      </div>
      
      <div class="error-message" id="errorMessage">
        Invalid URL. Please enter a valid Instagram, Facebook, TikTok, or YouTube link.
      </div>
      
      <div class="loader" id="loader">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p>Fetching video information...</p>
      </div>
    </section>
    
    <section class="video-preview" id="videoPreview">
      <div class="row">
        <div class="col-md-6">
          <div class="video-thumbnail">
            <img src="" id="thumbnailImg" alt="Video Thumbnail">
            <span class="video-duration" id="videoDuration">00:00</span>
          </div>
        </div>
        <div class="col-md-6">
          <h3 class="video-title" id="videoTitle">Video Title</h3>
          
          <!-- Format selection (only shows for YouTube) -->
          <div class="format-container" id="youtubeFormatContainer" style="display: none;">
            <div class="format-toggle">
              <button class="format-btn active" data-format="mp4">MP4 Video</button>
            </div>
            <div class="format-toggle">
              <button class="format-btn" data-format="mp3">MP3 Audio</button>
            </div>
          </div>
          
          <!-- Quality selection dropdown -->
          <div class="quality-dropdown">
            <select class="form-select" id="qualitySelect">
              <option value="360">360p</option>
              <option value="720" selected>720p</option>
              <option value="1080">1080p</option>
            </select>
          </div>
          
          <button class="download-btn" id="downloadBtn">Download</button>
          <a href="javascript:void(0)" class="download-link" id="downloadLink" style="display: none;" download>Download Now</a>
        </div>
      </div>
    </section>
    
    <!-- Rectangle Ad -->
    <div class="ad-container rectangle mx-auto" data-ad-slot="rectangle-ad">
      <span class="ad-text">Ad Space (300x250)</span>
    </div>
    
    <!-- Bottom Banner Ad -->
    <div class="ad-container banner mx-auto" data-ad-slot="bottom-banner">
      <span class="ad-text">Ad Space (728x90)</span>
    </div>
    
    <footer>
      <div class="disclaimer">
        <p><strong>Disclaimer:</strong> This service is designed for personal use only. Users are responsible for ensuring they have the right to download content. We do not host any videos on our servers and are not responsible for content downloaded through this service.</p>
      </div>
      <p>Â© 2025 All-in-One Video Downloader. All rights reserved.</p>
      <p>Powered by Serverless Functions on <span id="deployPlatform">Netlify/Vercel</span></p>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script id="app-script">
    document.addEventListener('DOMContentLoaded', function() {
      // DOM Elements
      const videoUrlInput = document.getElementById('videoUrl');
      const pasteBtn = document.getElementById('pasteBtn');
      const detectBtn = document.getElementById('detectBtn');
      const platformIcons = document.querySelectorAll('.platform-icon');
      const errorMessage = document.getElementById('errorMessage');
      const loader = document.getElementById('loader');
      const videoPreview = document.getElementById('videoPreview');
      const thumbnailImg = document.getElementById('thumbnailImg');
      const videoDuration = document.getElementById('videoDuration');
      const videoTitle = document.getElementById('videoTitle');
      const youtubeFormatContainer = document.getElementById('youtubeFormatContainer');
      const formatBtns = document.querySelectorAll('.format-btn');
      const qualitySelect = document.getElementById('qualitySelect');
      const downloadBtn = document.getElementById('downloadBtn');
      const downloadLink = document.getElementById('downloadLink');

      // State
      let detectedPlatform = null;
      let lastApiPayload = null; // stores API response for current URL
      let selectedFormat = 'mp4'; // default for YouTube
      let selectedQuality = '720';

      // Detect platform based on URL
      function detectPlatform(url) {
        platformIcons.forEach(icon => icon.classList.remove('active'));
        errorMessage.style.display = 'none';
        if (!url) return null;
        if (url.includes('instagram.com') || url.includes('instagr.am')) return 'instagram';
        if (url.includes('facebook.com') || url.includes('fb.com') || url.includes('fb.watch')) return 'facebook';
        if (url.includes('tiktok.com') || url.includes('vm.tiktok.com')) return 'tiktok';
        if (url.includes('youtube.com') || url.includes('youtu.be')) return 'youtube';
        return null;
      }

      // Update UI based on detected platform
      function updatePlatformUI(platform) {
        if (!platform) {
          errorMessage.style.display = 'block';
          errorMessage.textContent = 'Invalid URL. Please enter a valid Instagram, Facebook, TikTok, or YouTube link.';
          return;
        }
        platformIcons.forEach(icon => {
          if (icon.getAttribute('data-platform') === platform) icon.classList.add('active');
        });
        youtubeFormatContainer.style.display = platform === 'youtube' ? 'flex' : 'none';
        localStorage.setItem('lastUsedPlatform', platform);
        detectedPlatform = platform;
      }

      // Clipboard paste
      pasteBtn.addEventListener('click', async function() {
        try {
          const text = await navigator.clipboard.readText();
          videoUrlInput.value = text;
          updatePlatformUI(detectPlatform(text));
        } catch (err) {
          alert('Unable to access clipboard. Please paste the URL manually.');
        }
      });

      // Format toggle (YouTube only)
      formatBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          formatBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          selectedFormat = this.getAttribute('data-format');
        });
      });

      // Detect button: call backend + populate preview
      detectBtn.addEventListener('click', async function() {
        const url = videoUrlInput.value.trim();
        const platform = detectPlatform(url);
        updatePlatformUI(platform);
        if (!platform) return;

        loader.style.display = 'block';
        videoPreview.style.display = 'none';
        errorMessage.style.display = 'none';
        selectedQuality = qualitySelect.value;

        try {
          const res = await fetch(`/api/download?url=${encodeURIComponent(url)}`);
          const data = await res.json();
          loader.style.display = 'none';

          if (!data || !Array.isArray(data.medias) || data.medias.length === 0) {
            errorMessage.style.display = 'block';
            errorMessage.textContent = 'No downloadable media found for this link.';
            return;
          }

          lastApiPayload = data;

          // Populate UI
          thumbnailImg.src = data.picture || '';
          videoTitle.textContent = data.title || 'Video';
          videoDuration.textContent = data.duration || '';
          videoPreview.style.display = 'block';

          // Show the "Download" button, hide the direct link until resolved
          downloadBtn.style.display = 'block';
          downloadLink.style.display = 'none';

        } catch (err) {
          loader.style.display = 'none';
          errorMessage.style.display = 'block';
          errorMessage.textContent = 'Error fetching video information. Please try again.';
        }
      });

      // Resolve a media link based on selected format/quality
      function resolveMediaLink() {
        if (!lastApiPayload || !Array.isArray(lastApiPayload.medias)) return null;

        const medias = lastApiPayload.medias;

        // Determine desired extension/type:
        // - For YouTube: mp4 or mp3 based on UI toggle
        // - For others: prefer mp4
        const desiredExt = detectedPlatform === 'youtube' ? selectedFormat : 'mp4';

        // Normalize and score by quality preference
        const desiredQ = parseInt(selectedQuality, 10);

        // Filter by extension/type when present
        const filtered = medias.filter(m => {
          const ext = (m.extension || '').toLowerCase();
          const type = (m.type || '').toLowerCase(); // sometimes "audio"/"video"
          if (desiredExt === 'mp3') {
            return ext.includes('mp3') || type.includes('audio');
          } else {
            return ext.includes('mp4') || type.includes('video');
          }
        });

        const toPickFrom = filtered.length ? filtered : medias;

        // Choose the closest quality to desired
        const pick = toPickFrom
          .map(m => {
            // quality might be "720", "720p", "HD", etc.
            let q = 0;
            if (m.quality) {
              const match = String(m.quality).match(/\d{3,4}/);
              q = match ? parseInt(match[0], 10) : (m.type === 'audio' ? 0 : 720);
            }
            return { q, m };
          })
          .sort((a, b) => Math.abs(a.q - desiredQ) - Math.abs(b.q - desiredQ))
          .map(x => x.m)[0];

        return pick ? pick.url : null;
      }

      // Download button -> show direct link
      downloadBtn.addEventListener('click', function() {
        // Update selection in case user changed it just before clicking
        selectedQuality = qualitySelect.value;

        const link = resolveMediaLink();
        if (!link) {
          errorMessage.style.display = 'block';
          errorMessage.textContent = 'Unable to resolve a matching media file. Try a different quality/format.';
          return;
        }

        downloadBtn.style.display = 'none';
        downloadLink.style.display = 'block';
        downloadLink.href = link;
        downloadLink.textContent = 'Download Now';
      });

      // Detect platform on input change
      videoUrlInput.addEventListener('input', function() {
        const url = this.value.trim();
        updatePlatformUI(detectPlatform(url));
      });

      // Auto-detect deployment platform
      const deployPlatform = document.getElementById('deployPlatform');
      if (window.location.hostname.includes('netlify')) {
        deployPlatform.textContent = 'Netlify';
      } else if (window.location.hostname.includes('vercel')) {
        deployPlatform.textContent = 'Vercel';
      }

      // Restore last platform if available
      const lastUsedPlatform = localStorage.getItem('lastUsedPlatform');
      if (lastUsedPlatform) updatePlatformUI(lastUsedPlatform);
    });
  </script>
</body>
</html>
